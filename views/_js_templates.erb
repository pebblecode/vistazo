<%# Javascript templates for backbone.js views %>

<script type="text/template" id="new-project-dialog-template">
  <div id="new-project-dialog">
    <a href="#" class="close">'</a>
    <form id="new-tm-project-form" action="/" method="post">
      <input type="hidden" name="date" value=""/>
      <input type="hidden" name="team_member_id" value=""/>
      
      <%# Dummy div to be replaced by js %>
      <div id="existing-projects-listing"></div>

      <fieldset>
        <legend>Add new project</legend>
        <fieldset class="new-object-fieldset" title="New project">
          <label for="project_name">Add new project</label>
          <input type="text" name="project_name" title="Project name" class="new-object-text-box" /> <button type="submit" name="new_project" value="true" class="submit-button">+</button>
        </fieldset> <!-- New project -->
      </fieldset>
    </form>
    
    <div id="dialog-arrow"></div>
  </div>
</script>

<script type="text/template" id="existing-projects-listing-template">
  {% if (projects.length <= 0) { %}
    <div id="existing-projects-listing"></div>
  {% } else { %}
    <fieldset id="existing-projects-listing" title="Existing projects">
      <legend>Add a project</legend>
      <ul class="listing">
        {% _.each(projects, function(project) { %}
          <li>
            <div class="handle {{ project.css_class() }}"></div>
            <button name="project_id" type="submit" value="{{ project.get("id") }}" title="{{ project.get("name") }}">{{ project.get("name").substring(0, 40) }}</button>
            <a class="delete" title="Delete project" href="#">×</a>
          </li>
        {% }); %}
      </ul>
    </fieldset> <!-- Existing projects -->
  {% } %}
</script>

<script type="text/template" id="existing-project-template">
  <div class='project' data-team-member-id='{{ tmId }}' data-team-member-project-id='{{ tmProjId }}' data-date='{{ projDate }}'>
    <div class='handle-container'>
      <div class='{{ projHandleCssClass }}'></div>
    </div>
    <p class='project-title' title='{{ projName }}'>{{ projName.substring(0, 40) }}</p>
    <form class='delete-tm-project-form' action='/team-member/{{ tmId }}/project/{{ tmProjId }}/delete' method='post'>
      <button name='delete_project' type='submit' value='true'>×</button>
    </form>
  </div>
</script>


<script type="text/template" id="delete-project-dialog-template">
  <div id='delete-project-dialog' title='Delete &ldquo;{{ projectName }}&rdquo; project'>
    <p class='warning-icon'>W</p><p class='warning-msg'>All items added to the weekly timetable will also be deleted.</p>
    <form method='post' action='/{{ teamId }}/project/{{ projectId }}/delete'>
      <fieldset class='delete-object-fieldset' title='Delete project'>
      <button class='delete' value='delete' name='delete' type='submit'>delete</button>
      </fieldset>
    </form>
  </div>
</script>

<script type="text/template" id="week-template">
  <table id="timetable">
    <thead>
      <tr>
        <th class="first-row col1"> 
          <% if @prev_week_url.present? %>
            <div id="help-week"></div><a href="<%= @prev_week_url %>" class="arrows" title="Previous week">(</a>
          <% end %>
        </th>
      
        <th class="first-row col2">
          <p class="day"><%= @monday_date.strftime("%a") %></p> <p class="date"><%= @monday_date.day.ordinalize %></p><p class="month"><%= @monday_date.strftime("%b") %></p>
          
          <% if is_today?(@monday_date) %>
            <div class="today"></div>
          <% end %>
        </th>
        <th class="first-row col3">
          <p class="day"><%= @tuesday_date.strftime("%a") %></p> <p class="date"><%= @tuesday_date.day.ordinalize %></p><p class="month"><%= @tuesday_date.strftime("%b") %></p>
          
          <% if is_today?(@tuesday_date) %>
            <div class="today"></div>
          <% end %>
        </th>
        <th class="first-row col4">
          <p class="day"><%= @wednesday_date.strftime("%a") %></p> <p class="date"><%= @wednesday_date.day.ordinalize %></p><p class="month"><%= @wednesday_date.strftime("%b") %></p>
          
          <% if is_today?(@wednesday_date) %>
            <div class="today"></div>
          <% end %>
        </th>
        <th class="first-row col5">
          <p class="day"><%= @thursday_date.strftime("%a") %></p> <p class="date"><%= @thursday_date.day.ordinalize %></p><p class="month"><%= @thursday_date.strftime("%b") %></p>
          
          <% if is_today?(@thursday_date) %>
            <div class="today"></div>
          <% end %>
        </th>
        <th class="first-row col6">
          <p class="day"><%= @friday_date.strftime("%a") %></p> <p class="date"><%= @friday_date.day.ordinalize %></p><p class="month"><%= @friday_date.strftime("%b") %></p>
          
          <% if is_today?(@friday_date) %>
            <div class="today"></div>
          <% end %>
        </th>
        
        <th class="first-row col7">
          <p class="day"><%= @saturday_date.strftime("%a") %></p> <p class="date"><%= @saturday_date.day.ordinalize %></p><p class="month"><%= @saturday_date.strftime("%b") %></p>
          
          <% if is_today?(@saturday_date) %>
            <div class="today"></div>
          <% end %>
        </th>
        
        <th class="first-row col8">
          <p class="day"><%= @sunday_date.strftime("%a") %></p> <p class="date"><%= @sunday_date.day.ordinalize %></p><p class="month"><%= @sunday_date.strftime("%b") %></p>
          
          <% if is_today?(@sunday_date) %>
            <div class="today"></div>
          <% end %>
        </th>
        
        <th class="first-row col-last">
          <a href="<%= @next_week_url %>" class="arrows" title="Next week">)</a>
        </th>
      </tr>
    </thead>
    
    <tbody id="content">
      <%# Updated using js %>
    </tbody>
  </table>
</script>

<script type="text/template" id="team-member-template">
  <tr class="row-divider">
    <td colspan="9"><hr/></td>
  </tr>  <!--the divider-->
  <tr class="team-member {{ oddOrEvenClass }}" data-team-member-id="{{ tmId }}">
    <td class="{{ rowClass }} col1" title="{{ tmName }}">
      <a href="#edit-tm-{{ tmId }}" class="team-member-name">
        {{ tmName.substring(0, 40) }}
      </a>
      
      <div id="edit-tm-{{ tmId }}" class="edit-team-member-dialog" title="Edit team member name">
        <form action="/team-member/{{ tmId }}/edit" method="post">
          <fieldset class="update-object-fieldset" title="Edit team member">
            <legend>Edit team member</legend>
            <label for="name">Name</label>
            <input type="text" name="name" class="new-object-text-box" value="{{ tmName }}"/>
            <button type="submit" class="submit-button">update</button>
          </fieldset> <!-- Edit team member -->
        </form>
        
        <h4 class="add-new-user-title">Invite someone (note: needs to be a Google account)</h4>
        <%= erb :_invite_user_form %>
        
        <form action="/team-member/{{ tmId }}/delete" method="post">
          <fieldset class="delete-object-fieldset" title="Delete team member">
            <legend>Delete team member</legend>
            <p class="warning-icon">W</p><p class="warning-msg">All projects associated with '{{ tmName }}' will also be deleted.</p>
            <button type="submit" class="submit-button">delete</button>
          </fieldset> <!-- Edit team member -->
        </form>
      </div> <!-- .edit-team-member-dialog -->
    </td>
    
    <% prev_cols = 1 %>
    <% (MONDAY..SUNDAY).each do |work_day| %>
      <%#
        data-date: Used for update to know the date moving to, and the date when adding a project
        data-team-member-id: Used for adding a new project to know the team member to add to
      %>
      <% date = (@monday_date - 1.day) + work_day.day %>
      <td class="box {{ rowClass }} <%= "col#{work_day + prev_cols}" %>" data-date="<%= date %>" data-team-member-id="{{ tmId }}">

        {% _.each(tmProjects, function(proj) { %}
          {% if (proj["date"] == "<%= date %>") { %}
            <div class="project" data-team-member-id="{{ tmId }}" data-team-member-project-id="{{ proj['id'] }}" data-date="<%= date %>"> 
              <div class="handle-container"><div class="handle project-{{ proj['project_id'] }}"></div></div> <p class="project-title" title="{{ proj['project_name'] }}">{{ proj['project_name'].substring(0, 40) }}</p>
              <form class="delete-tm-project-form" action="/team-member/{{ tmId }}/project/{{ proj['id'] }}/delete" method="post">
                <button name="delete_project" type="submit" value="true">×</button>
              </form>
            </div>
          {% } %} 
        {% }); %}

        <% if (work_day == THURSDAY) %>
          {% if (isFirst) { %}
            <div id="help-project-container">
              <div id="help-project"></div>
            </div>
          {% } %}
        <% end %>
      </td>
    <% end %>
    <td class="{{ rowClass }} col-last" %></td>
  </tr>
</script>

<script type="text/template" id="new-team-member-row-template">
  <tr id="new-team-member-row">
    <td colspan="9" class="last-row col1">
      <form id="new-team-member-form" action="/<%= @team.url_slug %>/team-member/add" method="post">
        <fieldset class="new-object-fieldset" title="New team member">
          <legend>New team member</legend>
          <label for="new_team_member_name">Add new</label>
          <input type="text" name="new_team_member_name" title="Add member" class="new-object-text-box" /> 
          <button type="submit" name="new_team_member" value="new_team_member" class="submit-button">+</button>
          <div id="help-new"></div>
        </fieldset> <!-- New team member -->
      </form>
    </td>
  </tr>
</script>

<script type="text/template" id="project-listing-template">
  {% if (projects.length > 0) { %}
    {% _.each(projects, function(project, index) { %}
      {% var rowClass = "row" + (index + 1 + 1); %}
      {% var oddOrEvenClass = ((index % 2) === 0) ? "even" : "odd"; %}
      <tr class="row-divider">
        <td colspan="9"><hr/></td>
      </tr>  <!--the divider-->
      <tr class="project-row {{ oddOrEvenClass }}">
        <td class="{{ rowClass }} col1" title="{{ project.get("name") }}">
          <div class="project-title-container">
            <div class="handle {{ project.css_class() }}"></div>
            <p class="project-title" title="{{ project.get("name") }}">{{ project.get("name").substring(0, 40) }}</p>
          </div>
        </td>
        
        <% prev_cols = 1 %>
        <% (MONDAY..SUNDAY).each do |work_day| %>
          <% date = (@monday_date - 1.day) + work_day.day %>
          <td class="{{ rowClass }} <%= "col#{work_day + prev_cols}" %>" data-date="<%= date %>">

            {% var projectTeamMembers = []; %}
            {% _.each(teamMembers, function(teamMember) { %}
              {% var ttItems = teamMember.get("timetable_items"); %}
              {% _.each(ttItems, function(ttItem) { %}
                {% if ((ttItem["date"] == "<%= date %>") && (ttItem["project_id"] === project.get("id"))) { %}
                  <div class="team-member-name">{{ teamMember.get("name") }}</div>
                {% } %} 
              {% }); %}
            {% }); %}

          </td>
        <% end %>
        <td class="{{ rowClass }} col-last" %></td>
      </tr>
    {% }); %}
  {% } %}
</script>